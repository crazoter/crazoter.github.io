<!DOCTYPE html>
<html>
	<!--Things needed for your very own scenery thing:
		1. List of:
			a. Subreddits
			b. Gallery 
			i. Handle both separately
		2. Image of you / whatever in front of these images from these subreddits / galleries
			a. Editor
			b. Upload to imgur
		3. Background image (loading screen)
			a. Editor
			b. Convert to black & white
			c. Upload to imgur
		4. Preloader thumbnail
			a. Editor
			b. Handle preview of thumbnail 
			c. Upload to imgur
		5. Youtube music url (i need the id)
			a. If doesn't exist, remove the icon to mute music.
		6. Query String & Template Website
		-->
	<head>
		<meta charset="UTF-8"/>
		<meta http-equiv="Cache-Control" content="public"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, user-scalable=0"/>
		<meta name="description" content="Stand-in-front-of-scenery editor"/>
		<link rel="shortcut icon" href="assets/favicon_evan.ico"/>
		<title>Lol Editor</title>
  		<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
  		<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700' rel='stylesheet' type='text/css'>
  		<link rel="stylesheet" href="jquery-ui-1.11.4/jquery-ui.min.css"/>
  		<link rel="stylesheet" href="bgrins-spectrum-a7bb45b/spectrum.css"/>
		<link rel="stylesheet" href="css/evan.css"/>
		<style>
			* {
			    -moz-user-select: -moz-none;
			    -khtml-user-select: none;
			    -webkit-user-select: none;
			    -o-user-select: none;
			    user-select: none;
			}
			body {
				background-color: #FFF;
				/*background-image: url("assets/bgs/transp_bg.png");*/
			}
  			#preloader_text.preloader {
  				/*Set the background for the preloader*/
  				background: url(assets/joke/right.jpg);
  				background-size: 60px 60px;
    			background-repeat: no-repeat;
  			}
  			.mySlider {
  				width:50%;
				margin: 20px;
  			}
  			#imageCanvas {
    			z-index: 5;
  			}
  			#drawingCanvas {
  				position: absolute;
  				z-index: 7;
  			}
  			#cursorCanvas {
  				background-image: url("assets/bgs/transp_bg.png");
  			}
  			.bordered {
  				border-style: dashed;
  				border-width: 2px;
  			}
  			#div_tools {
  				position: absolute;
  				left: 0px;
  				top: 0px;
  				text-align: left;
  				background-color: #222;
  				color: #DDD;
  				padding: 10px;
  			}
  			.tools_row {
  				clear: both;
  				padding-top: 5px;
  				vertical-align: middle;
  			}
  			.tools_row > * {
				float: left;
  			}
  			.editTools_h1 {
  				font-size: 0.7em;
  				margin: 5px;
  			}
  			.editTools_p {
  				font-size: 0.5em;
  				min-width: 100px;
  			}
  			.ui-slider,.ui-slider-range {/*resize sliders*/
				height:5px !important;
  			}
  			.ui-slider-handle {
  				height: 20px !important;
  				width: 5px !important;
  				margin-left: 1px !important;
  			}
  			button {
  				color:#000;
  			}
  			.highlite {
  				background-color: #FFF;
  				color:#000;
  			}
  			/* unvisited link */
			a:link {
			    color: #ffff00;
			}

			/* visited link */
			a:visited {
			    color: #ffff00;
			}
			.main.title {
				position: relative;
			}

/**
 * custom layout
 */
	#main-wrap {
		background-color: #D9D9D9;
	}
	
	#content-wrap {
		background-color: #c5c5c5;
	}
	
	.info:first-child {background-color: #03A9F4;}
	.info:nth-child(2n+3) {background-color: #B3E5FC;}
	.info:nth-child(even) {background-color: #B2EBF2;}
	
	
	/* sizes */
	#main-wrap > div {
		position: absolute;
		z-index: 9999;
	}
	
	/* layout */
	
	#main-wrap {
		/* overflow to handle inner floating block */
		width: 100%;
		height: 100%;
	}
	
	#info-wrap {
		/* overflow to handle inner floating block */
		width: 100%;
		height: 100%;
	}
	
	.info {
		width: 33.3%;
		height:50%;
		float: left;
		color: #fff;
		font-family: sans-serif;
		line-height: 150%;
		text-shadow: 0 2px 2px #444;
	}
	.info.clickable {
		cursor: hand;
	}
	.info.clickable:hover {
		opacity: 0.7;
	}
	.info > h3 {
		padding-left: 3%;
	}
	.info > section {
		padding-left: 3%;
	}
	.info > p {
		font-size: 1.75rem;
		position: relative;
		top: 33%;
		left: 50%;
		transform: translate(-50%, -50%);
		text-align: center;
	}
	

  		</style>
		<script src="js/prefixfree.min.js"></script>
		<script src="js/pagespeed/modernizr.js"></script>
	</head>
	<body>
		<div id="main-wrap">
			<div id="info-wrap">
				<div class="info"><h3>Stand-in-front-of-scenery Editor</h3><section>Here is an <a href="https://crazoter.github.io/evan.html" target="_blank">example</a> of what you will be making!<br/>Create your own version now!</section><h3 id="components_text">0/6 components finished.<br/>WHAT ARE YOU WAITING FOR???</h3></div>
				<div class="info clickable" style="background-image: url(assets/joke/background_bg.png);background-repeat: no-repeat;background-size: 100% 100%"><p>Subreddits / Albums</p></div>
				<div id="div_setForeground" class="info clickable" onclick="set_foregroundScreen()" style="background-image: url(assets/joke/foreground_bg.png);background-repeat: no-repeat;background-size: 100% 100%"><p>Image of you / Foreground</p></div>
				<div class="info clickable" onclick="set_loadingScreen();"><p>Loading Screen</p></div>
				<div class="info clickable" style="background-image: url(assets/joke/preloader_bg.png);background-repeat: no-repeat;background-position: center;"><p>Preloader</p></div>
				<div class="info clickable" style="background-image: url(assets/joke/music_bg.png);background-repeat: no-repeat;background-position: center;"><p>Youtube Music Video URL</p></div>
			</div>
		</div>
		<!--header-->
		<div class="main title" style="display:none;">
			<!--Instructions-->
			<label id="label_instructions">Loading...</label><br/>
			<!--File upload-->
			<input type="file" id="imageLoader" name="imageLoader" style="display:none;"/>
			<!--Resizer slider & brush size slider-->
			<div id="resizer-slider" class="resizer-slider" style="margin: 20px;display:none;"></div>
			<!--Ok button-->
			<button id="btn_ok" type="button" title="Click me when you're done with whatever step you are at" style="display:none;">OK</button>
		</div>
		<!--Editing tools-->
		<div id="div_tools" style="display:none;" class="title">
			<div class="tools_row"><label id="hl_shift" class="editTools_h1">SHIFT</label><label id="hl_alt" class="editTools_h1">ALT</label><label id="hl_ctrl" class="editTools_h1">CTRL</label></div>
			<div class="tools_row"><label class="editTools_h1">Brush</label></div>
			<div class="tools_row"><span class="editTools_p">Type</span><button id="btn_erase" type="button" onclick="change_toolType(0);">ERASE</button><button id="btn_paint" type="button" onclick="change_toolType(1);">PAINT</button></div>
			<div class="tools_row"><span class="editTools_p">Color</span><input type='color' title="Change color of brush" class='color-picker' value='#f594d0' /></div>
			<div class="tools_row"><span class="editTools_p">Shape</span><button id="btn_block" type="button" onclick="change_brushShape(0);">BLOCK</button><button id="btn_circle" type="button" onclick="change_brushShape(1);">CIRCLE</button></div>
			<div class="tools_row"><span class="editTools_p">Size</span><div id="brushsize_slider" class="mySlider"></div></div>
			<div class="tools_row"><span class="editTools_p">Brush Preview</span><canvas id="cursorCanvas" class="bordered"></canvas></div>
			<div class="tools_row"><label class="editTools_h1">Image / Canvas</label></div>
			<div class="tools_row"><span class="editTools_p">Scale</span><div id="edit_resize_slider" class="mySlider resizer-slider"></div></div>
			<div class="tools_row"><span class="editTools_p">Canvas Size / Crop</span><div id="crop_slider" class="mySlider"></div></div>
			<div class="tools_row"><label class="editTools_h1">Controls / Shortcuts</label><br/>
			<label class="editTools_p">[ ] to scale brush size<br/>Alt + Left Mouse Button (LMB) for eyedropper
				<!--<br/>Alt + Scroll Wheel to zoom in and out-->
				<br/>Ctrl + Z / Y to <a href="#" onclick="imageHistoryBack();">undo</a> / <a href="#" onclick="imageHistoryForward();">redo</a><br/>Ctrl + LMB + Drag to position image</label></div>
			<div class="tools_row"><button type="button" onclick="resetImage();">RESET IMAGE</button></div>
		<!--content-->
		</div>
		<!--Image editing canvases-->
		<div class="glorious evan" style="display:none;">
			<canvas class="img evan" id="drawingCanvas">Please open this webpage on a HTML5 browser.</canvas>
			<canvas class="img evan" id="imageCanvas">Please open this webpage on a HTML5 browser.</canvas>
		</div>
		<script src="js/pagespeed/jquery.js"></script>
		<script src="jquery-ui-1.11.4/jquery-ui.min.js"></script>
		<script src="bgrins-spectrum-a7bb45b/spectrum.js"></script>
		<script type="text/javascript">
			//http://jsfiddle.net/influenztial/qy7h5/
				//DOM ELEMENTS
			var label_instructions = document.getElementById('label_instructions'),//title which acts as instructions
				imageLoader,//file upload for image
				imageCanvas = document.getElementById('imageCanvas'),//canvas for image
				imageCtx = imageCanvas.getContext('2d'),//variables related to imageCanvas
				imageGCO,
				drawingCanvas = document.getElementById('drawingCanvas'),
				drawingCtx = drawingCanvas.getContext('2d'),
				uploadedImg,//Actual image
				personDataURL,//Finalized data url of any person
				imageDisp = {x:0,y:0},//Actual image position
				imageWidth = 0,//Actual image dimensions
				imageHeight = 0,
				scale = 1,//Scale from original size
				cursorCanvas = document.getElementById('cursorCanvas'),//canvas for cursor AKA brush
				cursorCtx = cursorCanvas.getContext('2d'),//variables related to imageCanvas
				imageHistories = [],//imageHistory
				imageHistoryIndex = -1,
				imageHISTORY_LIMIT = 31,
				imageHistoryCallbackObject,
				pickingColor = false,
				okButtonHandler;

				function ImageHistory () {
					this.canvasWidth = imageCanvas.width;
					this.canvasHeight = imageCanvas.height;
					this.canvasScale = $('#edit_resize_slider').slider('value');
					this.img = null;
					this.ready = false;
				}

				//Mouse
				var mouseDown = false,//Mouse is down boolean
				mousePos = {x:0,y:0},//Mouse position
					//mousePos.x,mousePos.y, mousePos.prev_x,mousePos.prev_y
				hasDrawn = false,//Used to track if imageHistory is needed
				brushLength,//Mouse thickness (brush size)
				brushHardness = 95,
				toolIndex = 0,
				TOOLTYPE_ERASE = 0,//Tool IDs
				TOOLTYPE_PAINT = 1,
				brushTypeIndex = 0,//Brush type IDs
				BRUSHTYPE_BLOCK = 0,
				BRUSHTYPE_CIRCLE = 1,

				//Key
				KEYSDOWN = {
					SHIFT:false,CTRL:false,ALT:false
				},
				KEYS = {
					SHIFT:16,CTRL:17,ALT:18,
					SQ_BR_LEFT:219,SQ_BR_RIGHT:221,
					Y:89,Z:90
				},

				//STEP DATA
				stepIndex = 0,//Starts from 0
				STEP_DRAWING_START = 0,
				STEP_DRAWING_RESIZE = 1,
				STEP_DRAWING_EDIT = 2,
				STEP_DRAWING_TEXT = ["Step 1: Upload an image of you standing.","Step 2: Resize your image. When done, press OK.","Step 3: Erase unnecessary background. When done, press OK."],
				STEP_TEXT,

				//SLIDER_LIMITS
				SLIDER_LIMIT_RESIZE = [1,100,200],//0: lower bound (inclusive),1: starting value,2: upper bound (inclusive)
				SLIDER_LIMIT_BRUSHSIZE = [1,32,128],
				SLIDER_LIMIT_CROP = [1,100,200],
				SLIDER_LIMIT_HARDNESS = [1,95,100],

				COMPONENTS = [0,0,0,0,0];
				COMPONENTS_TEXT = ["0/5 components finished.<br/>WHAT ARE YOU WAITING FOR???","1/5 components finished.<br/>","2/5 components finished.<br/>","3/5 components finished.<br/>","4/5 components finished.<br/>ONE LAST TIME!","5/5 components finished!<br/>"];

			/**Setup options*/
			function transitActionToMain () {
				$('#main-wrap').show(200);
				$('.main.title').hide(200);
				var total = 0;
				for (var i = 0; i < COMPONENTS.length; i++) {
				    total += COMPONENTS[i] << 0;
				}
				$('#components_text').html(COMPONENTS_TEXT[total]);
			}
			function transitMainToAction () {
				$('#main-wrap').hide(200);
				$('.main.title').show(200);
				stepIndex = 0;
				okButtonHandler();
			}
			function set_foregroundScreen () {
				okButtonHandler = btnHandler_foreground;
				STEP_TEXT = STEP_DRAWING_TEXT;
				transitMainToAction();
			}
			function set_loadingScreen () {
				transitMainToAction();
			}

			/** Ok button handlers
			*/
				function btnHandler_foreground () {
					switch(stepIndex) {
						case STEP_DRAWING_START:
							//Start
							setTitleStep();
							//reset file upload
							$("#imageLoader").replaceWith($("#imageLoader").clone(true));
							imageLoader = document.getElementById('imageLoader');
							imageLoader.addEventListener('change', loadImage, false);
							$('#imageLoader').show(200);
							$("#btn_ok").hide();
						break;
			    		//Was at step 2, the resizing part
			    		case STEP_DRAWING_RESIZE:
			    			//move onto the editing part
			    			$('#resizer-slider').hide();
			    			$('#div_tools').show(300);
			    			++stepIndex;
			    			setTitleStep();
			    			break;
			    		case STEP_DRAWING_EDIT:
			    			personDataURL = imageCanvas.toDataURL();
			    			$("#div_tools").hide(200);
			    			$('.glorious.evan').hide(200);
			    			$("#div_setForeground").css("background-image","url("+personDataURL+")");
			    			COMPONENTS[1] = 1;
			    			transitActionToMain();
			    			break;
			    	}
				}

		    //mouse functionality
		    //http://miloq.blogspot.sg/2011/05/coordinates-mouse-click-canvas.html
		    //http://www.html5canvastutorials.com/advanced/html5-canvas-mouse-coordinates/
		    /**
		    	Get mouse position
		    */
		    function getMousePos(event) {
		    	mousePos.prev_x = mousePos.x;
		    	mousePos.prev_y = mousePos.y;
		    	var rect = imageCanvas.getBoundingClientRect();	
		        if (event.x != undefined && event.y != undefined)
		        {
		          mousePos.x = event.x;
		          mousePos.y = event.y;
		        }
		        else // Firefox method to get the position
		        {
		          mousePos.x = event.clientX + document.body.scrollLeft +
		              document.documentElement.scrollLeft;
		          mousePos.y = event.clientY + document.body.scrollTop +
		              document.documentElement.scrollTop;
		        }

		        mousePos.x -= rect.left;
		        mousePos.y -= rect.top;
		    }
		    function resizeCanvas (w,h) {
		    	imageCanvas.width = w;
		    	imageCanvas.height = h;
		    	drawingCanvas.width = w;
		    	drawingCanvas.height = h;
		    	$(drawingCanvas).offset($(imageCanvas).offset());
		    }
		    /**
		    	Function to centralize what happens when you click the canvas. If mouse down and move while LMB held down, also calls canvas click.
		    */
		    function canvasClick () {
		    	if(!pickingColor) {
			    	if(KEYSDOWN.ALT) {
			    		eyedrop();
			    	}
			    	else if(KEYSDOWN.CTRL) {
			    		hasDrawn = true;//lol lazy boy 95
			    		imageDisp.x += mousePos.x - mousePos.prev_x;
			    		imageDisp.y += mousePos.y - mousePos.prev_y;
			    		imageCtx.clearRect(0,0,imageCanvas.width,imageCanvas.height);
			    		imageCtx.drawImage(imageHistories[imageHistoryIndex].img,imageDisp.x,imageDisp.y);
			    	}
			    	else {
				    	hasDrawn = true;
				    	switch(toolIndex)
				    	{
				    		case TOOLTYPE_ERASE:
				    		if(brushTypeIndex === BRUSHTYPE_BLOCK)
								imageCtx.clearRect(mousePos.x - brushLength/2, mousePos.y - brushLength/2, brushLength, brushLength);
							else if(brushTypeIndex === BRUSHTYPE_CIRCLE) {
								imageGCO = imageCtx.globalCompositeOperation;
								imageCtx.globalCompositeOperation = "destination-out";
								imageCtx.drawImage(cursorCanvas, mousePos.x - brushLength/2, mousePos.y - brushLength/2);
								imageCtx.globalCompositeOperation = imageGCO;//reset
							}
							break;
							case TOOLTYPE_PAINT:
								if(drawingCanvas.style.opacity)
									imageCtx.globalAlpha = drawingCanvas.style.opacity;
								drawingCtx.drawImage(cursorCanvas, mousePos.x - brushLength/2, mousePos.y - brushLength/2);
								imageCtx.globalAlpha = 1;
				    		break;
				    	}
				    }
				}
		    }

		    /**
				Setup mouse cursor
			*/
			function setupCursor () {
				//brushLength = len;
				cursorCanvas.width = brushLength;
		    	cursorCanvas.height = brushLength;
		    	switch(toolIndex)
		    	{
		    		case TOOLTYPE_ERASE:
		    			cursorCtx.fillStyle="#F0F";
		    			//imageCtx.globalAlpha = 1;
		    			if(brushTypeIndex === BRUSHTYPE_BLOCK) {
					    	cursorCtx.fillRect(0,0,brushLength,brushLength);
					    	if(brushLength > 1) {
						    	cursorCtx.clearRect(1,1,brushLength-2,brushLength-2);
						    }
						} else if(brushTypeIndex === BRUSHTYPE_CIRCLE) {
							setupCircleCursor(100);
						}
					    break;
					case TOOLTYPE_PAINT:
						var tinyColor = $(".color-picker").spectrum("get");
						drawingCanvas.style.opacity = tinyColor._a;
						//imageCtx.globalAlpha = tinyColor._a;
						tinyColor._a = 1;
						cursorCtx.fillStyle = tinyColor;
						if(brushTypeIndex === BRUSHTYPE_BLOCK) {
					    	cursorCtx.fillRect(0,0,brushLength,brushLength);
						} else if(brushTypeIndex === BRUSHTYPE_CIRCLE) {
							setupCircleCursor(100);
						}
						break;
				}
		    	drawingCanvas.style.cursor = "url("+cursorCanvas.toDataURL()+") "+brushLength/2+" "+brushLength/2+", auto";
			}
			function setupCircleCursor (hardness) {
				if(hardness >= 100)
				{
					cursorCtx.beginPath();
					cursorCtx.arc(brushLength/2, brushLength/2, brushLength/2, 0, 2 * Math.PI, false);
					cursorCtx.fill();
				}
			}
		    /**
		    	Handle Loading of Image
		    */
			function loadImage(e){
			    var reader = new FileReader();
			    reader.onload = function(event){
			        uploadedImg = new Image();
			        uploadedImg.onload = function(){
			        	//Initialize image that is loaded
			        	resetImage();

			            //Step 2
			            ++stepIndex;
			            $(imageLoader).hide();
			            $('.glorious.evan').fadeIn(200);
			            $("#resizer-slider").show();
			            $("#btn_ok").show();
			            setTitleStep();
			        }
			        uploadedImg.src = event.target.result;
			    }
			    reader.readAsDataURL(e.target.files[0]);
			}

			function resetImage () {
				imageWidth = uploadedImg.width;
	        	imageHeight = uploadedImg.height;
	        	resizeCanvas(uploadedImg.width,uploadedImg.height);
	            imageCtx.drawImage(uploadedImg,0,0);
	            saveToImageHistory();//init imageHistory
			}
			/**
				Set title step
			*/
			function setTitleStep () {
				label_instructions.innerHTML = STEP_TEXT[stepIndex];
			}

			/**
				Slider methods
			*/
			function slider_resize (event,ui) {
				if(uploadedImg) {
		      		//set the scale
			      	scale = ui.value / 100;
			        //resize the canvas & image
			        resizeCanvas(imageWidth*scale,imageHeight*scale);
			        imageCtx.drawImage(imageHistories[imageHistoryIndex].img,0,0,imageCanvas.width,imageCanvas.height);
			    }
			}
			function keypressBrushSizeSliderChange (newVal) {
				if(newVal >= SLIDER_LIMIT_BRUSHSIZE[0] && newVal <= SLIDER_LIMIT_BRUSHSIZE[2]) {
					$("#brushsize_slider").slider('value',newVal);
					return true;
				}
				return false;
			}

			/**
				Edit Tools
			*/
			function change_toolType (val) {
				toolIndex = val;
				var $erase = $("#btn_erase"), $paint = $("#btn_paint");
				switch(val)
				{
					case TOOLTYPE_PAINT:
						$erase.prop('disabled', false);
						$erase.removeAttr("style");
						$paint.prop('disabled', true);
						$paint.attr("style","transform: scale(1.2)");
					break;
					case TOOLTYPE_ERASE:
						$erase.prop('disabled', true);
						$erase.attr("style","transform: scale(1.2)");
						$paint.prop('disabled', false);
						$paint.removeAttr("style");
					break;
				}
				setupCursor();
			}
			function change_brushShape (val) {
				brushTypeIndex = val;
				var $block = $("#btn_block"), $circle = $("#btn_circle");
				switch(val)
				{
					case BRUSHTYPE_CIRCLE:
						$block.prop('disabled', false);
						$block.removeAttr("style");
						$circle.prop('disabled', true);
						$circle.attr("style","transform: scale(1.2)");
					break;
					case BRUSHTYPE_BLOCK:
						$block.prop('disabled', true);
						$block.attr("style","transform: scale(1.2)");
						$circle.prop('disabled', false);
						$circle.removeAttr("style");
					break;
				}
				setupCursor();
			}
			function saveToImageHistory () {
				if(imageHistoryIndex < imageHISTORY_LIMIT)
					++imageHistoryIndex;
				while (imageHistories.length > imageHistoryIndex) {//pop if went back and overrode "future" history
					imageHistories.pop();
				}
				imageHistoryAdd(imageCanvas.toDataURL());
				while(imageHistories.length >= imageHISTORY_LIMIT) {//shift if exceeded history length
					imageHistories.shift();
				}
			}
			function imageHistoryBack () {
				if(imageHistoryIndex > 0) {
					--imageHistoryIndex;
					redrawImageCanvas(imageHistories[imageHistoryIndex]);
				}
			}
			function imageHistoryForward () {
				if(imageHistoryIndex < imageHistories.length - 1) {
					++imageHistoryIndex;
					redrawImageCanvas(imageHistories[imageHistoryIndex]);
				}
			}
			function imageHistoryAdd (dataURL) {
				var imageHistory = new ImageHistory();
				var img = document.createElement('IMG');
				img.onload = function () {
					imageHistory.ready = true;
					console.log('loaded');
					console.log(imageHistoryIndex);
					console.log(imageHistory);
					if(imageHistoryCallbackObject === imageHistory) {
						console.log('refire');
						redrawImageCanvas(imageHistory);
					}
				};
				img.src = dataURL;
				imageHistory.img = img;
				imageHistories.push(imageHistory);
			}
			function redrawImageCanvas (imageHistory) {
				console.log('redrawing');
				console.log(imageHistoryIndex);
				console.log(imageHistory);
				if(imageHistory.ready) {
					if(imageHistory.canvasWidth !== imageCanvas.width || imageHistory.canvasHeight !== imageCanvas.height) {
						resizeCanvas(imageHistory.canvasWidth,imageHistory.canvasHeight);
			        }
			        if($('#edit_resize_slider').slider('value') !== imageHistory.canvasScale) {
			        	$('.resizer-slider').slider('value',imageHistory.canvasScale);
			        }
					imageCtx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
			        imageCtx.drawImage(imageHistory.img, 0, 0);
				}
				else {//prep it for redrawing
					console.log('redraw prep');
					console.log(imageHistory);
					imageHistoryCallbackObject = imageHistory;
				}
			}

			//http://jsfiddle.net/DV9Bw/1194/
			function rgbToHex(r, g, b) {
			    if (r > 255 || g > 255 || b > 255)
			        throw "Invalid color component";
			    return ((r << 16) | (g << 8) | b).toString(16);
			}
			function eyedrop () {
				var p = imageCtx.getImageData(mousePos.x, mousePos.y, 1, 1).data;
				var hex = "#" + ("000000" + rgbToHex(p[0], p[1], p[2])).slice(-6);
				$(".color-picker").spectrum("set", hex);
				setupCursor();
			}

			//Onload
			$(function() {
				//Setup instructions
				//setTitleStep();
				change_toolType(TOOLTYPE_ERASE);
				change_brushShape(BRUSHTYPE_BLOCK);

				//Initialize Color Picker
				$('.color-picker').spectrum({
					preferredFormat: "hex3",
					showPalette: true,
					showAlpha: true,
					showInitial: true,
					change: function(color) {
					    setupCursor();
					},
					show: function(color) {
					    pickingColor = true;
					},
					hide: function(color) {
					    pickingColor = false;
					}
				});

				//Mouse Event handlers
				$('body').mouseup(function(){//mouse up
					mouseDown = false;
					if(hasDrawn && !pickingColor) {
						//if(!KEYSDOWN.CTRL) {//not moving
						console.log('yes');
						imageDisp.x = 0;
						imageDisp.y = 0;
						imageCtx.drawImage(drawingCanvas,0,0);
						drawingCtx.clearRect(0,0,imageCanvas.width,imageCanvas.height);
						saveToImageHistory();
						hasDrawn = false;
						//}
					}
				})
				.mousedown(function(){//mouse down
					mouseDown = true;
					if ($(drawingCanvas).is(':hover')) {
						//if is over the canvas
				        canvasClick();
				    }
				});
				drawingCanvas.addEventListener('mousemove', function(evt) {//mouse move (while over canvas)
		        	getMousePos(evt);
		        	if(mouseDown)
		        		canvasClick();
		        });

				//Key Event handlers
				$('body').keydown(function(event) {
					switch(event.which)
					{
						case KEYS.CTRL:
							KEYSDOWN.CTRL = true;
							$('#hl_ctrl').addClass('highlite');
						break;
						case KEYS.ALT:
							KEYSDOWN.ALT = true;
							$('#hl_alt').addClass('highlite');
							drawingCanvas.style.cursor = "crosshair";
						break;
						case KEYS.SHIFT:
							KEYSDOWN.SHIFT = true;
							$('#hl_shift').addClass('highlite');
						break;
						//brush size smaller
						case KEYS.SQ_BR_LEFT:
							if(keypressBrushSizeSliderChange(brushLength-1))
								--brushLength;
						break;
						//brush size bigger
						case KEYS.SQ_BR_RIGHT:
							if(keypressBrushSizeSliderChange(brushLength+1))
								++brushLength;
						break;
					}
				})
				.keyup(function(event) {
					//console.log(event.which);
					switch(event.which)
					{
						case KEYS.CTRL:
							KEYSDOWN.CTRL = false;
							$('#hl_ctrl').removeClass('highlite');
						break;
						case KEYS.ALT:
							KEYSDOWN.ALT = false;
							$('#hl_alt').removeClass('highlite');
							setupCursor();
						break;
						case KEYS.SHIFT:
							KEYSDOWN.SHIFT = false;
							$('#hl_shift').removeClass('highlite');
						break;
						case KEYS.Y:
							if(KEYSDOWN.CTRL)
								imageHistoryForward();
						break;
						case KEYS.Z:
							if(KEYSDOWN.CTRL) {
								imageHistoryBack();
							}
						break;
					}
				});

				//Setup resizing slider
			    $(".resizer-slider").slider({
			      range: "min",
			      value: SLIDER_LIMIT_RESIZE[1],
			      min: SLIDER_LIMIT_RESIZE[0],
			      max: SLIDER_LIMIT_RESIZE[2],
			      change: function( event, ui ) {
			      	console.log('resizer change');
			      	$(imageCanvas).removeClass('bordered');
			      	//saveToImageHistory();//lel
			      },
			      slide: function( event, ui ) {
			      	console.log('resizer slide');
			      	$(imageCanvas).addClass('bordered');
			      	slider_resize(event,ui);
			      }
			    });

			    //Setup brush size slider
    			$("#brushsize_slider").slider({
			      range: "min",
			      value: SLIDER_LIMIT_BRUSHSIZE[1],
			      min: SLIDER_LIMIT_BRUSHSIZE[0],
			      max: SLIDER_LIMIT_BRUSHSIZE[2],
			      change: function( event, ui ) {
			      	brushLength = ui.value;
			      	setupCursor();
			      },
			      slide: function( event, ui ) {
			      	brushLength = ui.value;
			      	setupCursor();
			      }
			    });
			    brushLength = 32;
			    setupCursor();

			    //Setup brush hardness slider - currently doesn't exist
    			$("#hardness_slider").slider({
			      range: "min",
			      value: SLIDER_LIMIT_HARDNESS[1],
			      min: SLIDER_LIMIT_HARDNESS[0],
			      max: SLIDER_LIMIT_HARDNESS[2],
			      change: function( event, ui ) {
			      	brushHardness = ui.value;
			      	setupCursor();
			      },
			      slide: function( event, ui ) {
			      	brushHardness = ui.value;
			      	setupCursor();
			      }
			    });

			    //Setup crop slider
			    $("#crop_slider").slider({
				  range: "min",
			      value: SLIDER_LIMIT_CROP[1],
			      min: SLIDER_LIMIT_CROP[0],
			      max: SLIDER_LIMIT_CROP[2],
			      change: function( event, ui ) {
			      	//resize and offset image drawing to make it look like it is cropped
			      	if(ui.value !== 100) {
				      	$(drawingCanvas).removeClass('bordered');
				      	var dCanvasOffset = $(drawingCanvas).offset();
				      	var iCanvasOffset = $(imageCanvas).offset();
				      	var imgDisplacement = {x:iCanvasOffset.left - dCanvasOffset.left,y:iCanvasOffset.top - dCanvasOffset.top};
				      	var prevDim = {width:imageCanvas.width,height:imageCanvas.height};
				      	resizeCanvas(drawingCanvas.width,drawingCanvas.height);
				      	imageCtx.drawImage(imageHistories[imageHistoryIndex].img,imgDisplacement.x,imgDisplacement.y,prevDim.width,prevDim.height);
				      	saveToImageHistory();//lel
				      	$("#crop_slider").slider('value',100);//reset value
				    }
			      },
			      slide: function( event, ui ) {
			      	//crop while keeping the thing centered. Use the drawing canvas to "on top"
			      	var newOffset = $(imageCanvas).offset();
					drawingCanvas.width = imageCanvas.width * ui.value / 100;
					drawingCanvas.height = imageCanvas.height * ui.value / 100;
					newOffset.left += (imageCanvas.width - drawingCanvas.width) / 2;
					newOffset.top += (imageCanvas.height - drawingCanvas.height) / 2;
					$(drawingCanvas).addClass('bordered').offset(newOffset);
			      }
			    });

			    //Setup OK button
			    $("#btn_ok").click(function() {
			    	okButtonHandler();
			    });
			});
		</script>
	</body>
</html>